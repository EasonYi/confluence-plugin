<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114996686-1"></script>
    <script type="text/javascript" src="js/google-analytics.js"></script>
    <meta charset="utf-8">
    <script type="text/javascript" src="js/util.js"></script>
    <script id="connect-loader">

      function initializeMacro() {
        const initialVersion = 1;
        let macroParams = {param: initialVersion};
        let bodyProperty;

        AP.confluence.getMacroData(data => {
          macroParams = data || macroParams;
          macroParams.uuid = macroParams.uuid || uuidv4();
          macroParams.param = macroParams.param || initialVersion;

          const key = propertyKey(macroParams.uuid);
          bodyProperty = {key: key, value: '', version: {number: 0}};

          AP.confluence.getContentProperty(key, function(property) {
            bodyProperty = property || bodyProperty;

            let body = property && property.value;
            if(!body) {
              AP.confluence.getMacroBody(data => {
                body = data;
              });
            }
            store.commit('code', body || EXAMPLE);
          });
        });

        AP.require(["confluence", "dialog"], function (confluence, dialog) {
          function onSubmit() {
            const macroBody = store.state.code;
            macroParams.param = macroParams.param + 1;
            confluence.saveMacro(macroParams, macroBody);

            bodyProperty.version.number = bodyProperty.version.number + 1;
            bodyProperty.value = macroBody;
            AP.confluence.setContentProperty(bodyProperty, function(result) {
              console.warn(result.error);
            });

            confluence.closeMacroEditor();
            return true;
          }

          dialog.getButton("submit").bind(onSubmit);
        });
      }

      function loadConnect() {
        JavaScript.load(getConnectUrl(), initializeMacro);
      }

      window.onAppLoaded = window.location.href.indexOf('localhost') ? null : loadConnect;

      window.split = true;

    </script>
    <script type="text/javascript" src="js/heap.js"></script>
    <link href="css/diagram_<%= htmlWebpackPlugin.options.product_type %>.css" rel="stylesheet">
</head>
<body style="height: 100vh;">
<div id="app" class="container">
    <workspace></workspace>
</div>
<!-- built files will be auto injected -->
</body>
</html>
